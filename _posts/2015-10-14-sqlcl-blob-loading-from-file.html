---
layout: post
title: SQLCL - Blob loading from a file
date: '2015-10-14T07:40:00.000-07:00'
author: Kris Rice
tags:
- sqlcl
modified_time: '2016-06-10T13:03:58.803-07:00'
thumbnail: http://1.bp.blogspot.com/-BZcNRARhol0/Vh5h3cUMBpI/AAAAAAAABGM/u2manw3DuW4/s72-c/Screen%2BShot%2B2015-10-14%2Bat%2B10.08.02.png
blogger_id: tag:blogger.com,1999:blog-37621059.post-2500879315635259494
blogger_orig_url: http://krisrice.blogspot.com/2015/10/sqlcl-blob-loading-from-file.html
---

There is a ton of ways having new scripting in sqlcl can help. &nbsp;One example is a simpler way to load a local file into a BLOB in a column.<br /><br />Prior to this the only options I know of would be to write custom code or move the files to the server and use utl_file or xdb or some combination of things like this.<br /><br /><h4>Enter SQLCL and javascript method #1.</h4><br />Here's a simple script which loads a local file into a temp BLOB and uses that as a bind variable in the insert statement<br /><br /><pre class="brush:javascript;">/*<br />/*<br />*  Function to take in a filename and add or create it to a map<br />*  with bind variables<br />*/<br />function addBindToMap(map,bindName,fileName){<br />     /*  conn is the actual JDBC connection */<br />     var b = conn.createBlob();<br /><br />     var out = b.setBinaryStream(1);<br /><br />     var path = java.nio.file.FileSystems.getDefault().getPath(fileName);<br /><br />     /* slurp the file over to the blob */<br />     java.nio.file.Files.copy(path, out);<br />     out.flush();<br /><br />     if ( map == null ) {<br />         /* java objects as binds needs a hashmap */<br />         var HashMap = Java.type("java.util.HashMap");<br />         map = new HashMap();<br />     }<br />     /* put the bind into the map */<br />     map.put("b",b);<br /> return map;<br />}<br /><br /><br />/* File name */<br />var file = "/Users/klrice/workspace/raptor_common/10_5.log";<br /><br />/* load binds */<br />binds = addBindToMap(null,"b",file);<br /><br />/* add more binds */<br />binds.put("path",file);<br /><br />/* exec the insert and pass binds */<br />var ret = util.execute("insert into k(path,blob_content,when) values(:path , :b, sysdate)",binds);<br /><br />/* print the results */<br />sqlcl.setStmt("select path,dbms_lob.getlength(blob_content) from k order by when desc;");<br /><br />sqlcl.run();<br /></pre><br /><br /><br />Running it is as expected. &nbsp;One new row and showing the blob size. &nbsp;The only difference here is that you can avoid typing s-c-r-i-p-t and save 2 letters with just scri.<br /><br /><br /><div class="separator" style="clear: both; text-align: left;"><a href="http://1.bp.blogspot.com/-BZcNRARhol0/Vh5h3cUMBpI/AAAAAAAABGM/u2manw3DuW4/s1600/Screen%2BShot%2B2015-10-14%2Bat%2B10.08.02.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-BZcNRARhol0/Vh5h3cUMBpI/AAAAAAAABGM/u2manw3DuW4/s1600/Screen%2BShot%2B2015-10-14%2Bat%2B10.08.02.png" /></a></div><br /><br /><h4>Method #2 shared library</h4>I'll be making a library intended to make some things easier such as file loading and creating the hashmap. &nbsp;So taking out this blob loading as an example there first 2 things to put into such a library in helpers.js<br /><br /><br /><pre class="brush:javascript;">/*<br />    This is a javascript library to make some of the common things<br />    in SQLCL simplier.<br />*/<br /><br />var helpers = {} ;<br /><br />/* for complex type a java hashmap is needed for binds */<br />helpers.getBindMap = function(){<br />   var HashMap = Java.type("java.util.HashMap");<br />   map = new HashMap();<br />   return map;<br />};<br /><br />/* create a temp blob and load it from a local to sqlcl file */<br />helpers.getBlobFromFile=function (fileName){<br />     var b = conn.createBlob();<br />     var out = b.setBinaryStream(1);<br />     var path = java.nio.file.FileSystems.getDefault().getPath(fileName);<br />     java.nio.file.Files.copy(path, out);<br />     out.flush();<br /> return b;<br />};<br /><br /></pre><br />Now the blob loading script can be reduced to something like this<br /><br /><pre class="brush:javascript;">load('helpers.js');<br /><br />/* File name */<br />var file = "/Users/klrice/workspace/raptor_common/10_5.log";<br /><br />/* load binds */<br />binds = helpers.getBindMap();<br /><br />/* add more binds */<br />binds.put("path",file);<br /><br />blob = helpers.getBlobFromFile(file);<br /><br />binds.put("b",blob);<br /><br /><br />/* exec the insert and pass binds */<br />var ret = util.execute("insert into k(path,blob_content,when) values(:path , :b, sysdate)",binds);<br /><br /></pre><br /><br /><br />I'll be cleaning up this helpers.js and hosting it soon with frequent additions to new functions.