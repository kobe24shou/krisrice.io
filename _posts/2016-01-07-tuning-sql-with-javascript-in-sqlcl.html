---
layout: post
title: Tuning SQL with Javascript in SQLCL
date: '2016-01-07T11:22:00.001-08:00'
author: Kris Rice
tags:
- sqlcl
modified_time: '2016-06-10T13:03:58.860-07:00'
thumbnail: http://2.bp.blogspot.com/-73e3lMSQJnE/Vo64-OF9H8I/AAAAAAAABI8/XXX_nEcS600/s72-c/Screen%2BShot%2B2016-01-07%2Bat%2B14.13.34.png
blogger_id: tag:blogger.com,1999:blog-37621059.post-9012247501818428580
blogger_orig_url: http://krisrice.blogspot.com/2016/01/tuning-sql-with-javascript-in-sqlcl.html
---

In case anyone missed it, #sqlcl has the ability to run javascript. This opens a lot of options. &nbsp;Here's a simple example that shows how to using javascript.<br /><br /><ul><li>Open a new Database Connection</li><li>Collect stats on the base connection</li><li>Do work on the main connection</li><li>Collect stats again</li><li>Only Print the stats that changed</li></ul><br /><br />In SQL Developer, the autotrace feature has for a long time selected the session statistics and display them. &nbsp;Then you can diff those to another run and see what changes. &nbsp;Jeff of course has <a href="http://www.thatjeffsmith.com/archive/2013/07/explain-plan-and-autotrace-enhancements-in-oracle-sql-developer-4/">blogs on this</a>&nbsp;That's great but where's it leave a #sqlcl user? Enter JavaScript.<br /><br />Here's the end result. &nbsp;I ran a select count on all_objects filtered to DBA_%. &nbsp;The things to notice is the Work Session's SID and Monitor Session's SID is different and printed to show I didn't cheat. &nbsp;The command to execute is just passed as arguments to the script command. &nbsp;The result is the count ran. I got the stats before and after. &nbsp;Then it's just a simple loop comparing them to see what changed and print on the far right the actual difference.<br /><br />The JavaSript is below and has comments enough to follow hopefully. &nbsp;I'll post it to our #sqlcl github examples directory shortly.<br /><br /><br /><br /><a href="http://2.bp.blogspot.com/-73e3lMSQJnE/Vo64-OF9H8I/AAAAAAAABI8/XXX_nEcS600/s1600/Screen%2BShot%2B2016-01-07%2Bat%2B14.13.34.png" imageanchor="1"><img border="0" src="http://2.bp.blogspot.com/-73e3lMSQJnE/Vo64-OF9H8I/AAAAAAAABI8/XXX_nEcS600/s1600/Screen%2BShot%2B2016-01-07%2Bat%2B14.13.34.png" /></a><br /><br /><br /><br /><pre class="brush:js;">// declare the 2 java files needed<br />var DriverManager = Java.type("java.sql.DriverManager");<br />var DBUtil  = Java.type("oracle.dbtools.db.DBUtil");<br /><br /><br />// Create a new connection to use for monitoring<br />var jdbc = conn.getMetaData().getURL();<br />var user = 'klrice';<br />var pass = 'klrice';<br />//connect<br />var conn2 = DriverManager.getConnection(jdbc,user,pass);<br />var util2 = DBUtil.getInstance(conn2);<br /><br />// probably a better way to rpad a string<br />function pad(s,n){<br />   s = s.toString() + "                                                                    ";<br />   return ( s.substring(0,n));<br />}<br /><br />//<br />// Simple function to grab the session stats and put them into JSON<br />//<br />function stats2json(sid){<br />     var binds = {};<br />     binds.SID = sid;<br /><br />     var list = util2.executeReturnList("select name,value from v$statname sn,v$sesstat  s where sn.statistic# = s.STATISTIC# and s.SID= :SID",binds);<br />     var ret={};<br />     for (var i = 0; i &lt; list.length; i++) {<br />             ret[list[i].NAME] = parseInt(list[i].VALUE);<br />     }<br />   return ret;<br />}<br /><br />//<br />// Simple function to grab the session details and put them into JSON<br />//<br />function getSession(util){<br />      /* Current active SQL Connection */<br />      var results = util.executeReturnList("select sys_context('USERENV','session_user') u,sys_context('USERENV','SESSIONID') sessionID,sys_context('USERENV','SID') sid from dual",null);<br /><br />      var ret = {};<br />          ret.user      = results[0].U;<br />          ret.sid       = results[0].SID;<br />          ret.sessionid = results[0].SESSIONID;<br /><br />      ctx.write("\tUser:" + ret.user + "\n");<br />      ctx.write("\tSID:" + ret.sid + "\n");<br />      ctx.write("\tSession:" + ret.sessionid + "\n");<br /><br />     return ret;<br />}<br /><br />// rebuild the arguments which are the commands to run<br />var sql="";<br />for(var i=1;i&lt;args.length;i++){<br />  sql = sql + " " + args[i];<br />}<br /><br />// print the sessions to prove they are different<br />ctx.write("--Work Session--\n");<br />var session = getSession(util);<br /><br />ctx.write("--Monitor Session--\n");<br />var session2 = getSession(util2);<br /><br />// grabt the stats before<br />var before = stats2json(session.sid);<br /><br />// rebuild the sql from the arguments<br />ctx.write("Command:\n\t"+ sql + "\n\n");<br />sqlcl.setStmt(sql);<br /><br />// run it<br />sqlcl.run();<br /><br />// get the after session stats<br />var after = stats2json(session.sid);<br /><br />ctx.write("Session Stat Changes:\n\n");<br /><br />// walk the stats and print the deltas<br />for(var key in before){<br />   // print only stats that changed<br />   if ( before[key] !=  after[key] ) {<br />     ctx.write( pad(key,64) + "\t\t "+ pad(before[key],12) + " --- "+ pad(after[key],12) + "\t "  );<br />     ctx.write( pad((after[key]-before[key]),12) + "\n");<br />   }<br />}<br /></pre>