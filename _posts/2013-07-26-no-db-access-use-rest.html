---
layout: post
title: No DB access? Use REST
date: '2013-07-26T07:37:00.001-07:00'
author: Kris Rice
tags: 
modified_time: '2013-07-26T07:37:29.535-07:00'
thumbnail: http://4.bp.blogspot.com/-O4EVxjVkwME/UfJ8IFreHOI/AAAAAAAAArM/pNo2Qhb5O9A/s72-c/kris.rice@oracle.com.jpeg
blogger_id: tag:blogger.com,1999:blog-37621059.post-5876336973677159620
blogger_orig_url: http://krisrice.blogspot.com/2013/07/no-db-access-use-rest.html
---

<span style="font-size: x-large;">The problem.</span><br /><br />&nbsp; &nbsp;There's an arbitrary sized image in a database which needed to be made square, sized into 4 sizes, and have a border to color match the picture ( <a href="http://www.panic.com/blog/2012/12/itunes-11-and-colors/">like iTunes albums</a> ) . &nbsp;Also, do it in batches so as not to cause unneeded load on the database. &nbsp;Then a minor detail of there's no direct sqlnet access to the db.<br /><br />&nbsp; Here's the current result. &nbsp;The original picture was an now quite square at 490x604<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-O4EVxjVkwME/UfJ8IFreHOI/AAAAAAAAArM/pNo2Qhb5O9A/s1600/kris.rice@oracle.com.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://4.bp.blogspot.com/-O4EVxjVkwME/UfJ8IFreHOI/AAAAAAAAArM/pNo2Qhb5O9A/s320/kris.rice@oracle.com.jpeg" width="257" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: left;">The result is much more uniform</div><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-PxfJLrOLD1g/UfJ8IfeKpmI/AAAAAAAAArU/_H07L6QEqSk/s1600/kris.rice@oracle.com_80.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-PxfJLrOLD1g/UfJ8IfeKpmI/AAAAAAAAArU/_H07L6QEqSk/s1600/kris.rice@oracle.com_80.jpeg" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-tpOsrRFjMC8/UfJ8ICQ98RI/AAAAAAAAArc/feLFB6uxDRg/s1600/kris.rice@oracle.com_180.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-tpOsrRFjMC8/UfJ8ICQ98RI/AAAAAAAAArc/feLFB6uxDRg/s1600/kris.rice@oracle.com_180.jpeg" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-4_jwcT0N3Bc/UfJ8IB3MyqI/AAAAAAAAArI/cwSBYdH4Sok/s1600/kris.rice@oracle.com_436.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://2.bp.blogspot.com/-4_jwcT0N3Bc/UfJ8IB3MyqI/AAAAAAAAArI/cwSBYdH4Sok/s320/kris.rice@oracle.com_436.jpeg" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: center;"><br /></div><h2><span style="font-size: x-large;">The list of work.</span></h2><div class="separator" style="clear: both; text-align: left;">&nbsp; Subsetting the list to be done was the simplest part. &nbsp;A RESTful service defined which ties who has images to what to do produced this list. &nbsp;This was my test on myself but it can obvious be opened up to do any subset or lower the pagination and process one page at a time.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-CUBXcPvorSY/UfJ9ruwyxNI/AAAAAAAAArw/SO1kho1vAfI/s1600/Screen+Shot+2013-07-26+at+9.44.58+AM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="352" src="http://2.bp.blogspot.com/-CUBXcPvorSY/UfJ9ruwyxNI/AAAAAAAAArw/SO1kho1vAfI/s400/Screen+Shot+2013-07-26+at+9.44.58+AM.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: left;"><br /></div><h2><span style="font-size: x-large;">The original image.</span></h2><div class="separator" style="clear: both; text-align: left;">&nbsp; There's not much to say here since I covered how to get an image out over REST <a href="http://krisrice.blogspot.com/2013/07/using-restful-to-deliver-images-for-apex.html">here</a>.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;"><br /></div><h2><span style="font-size: x-large;">The processing.</span></h2><div class="separator" style="clear: both; text-align: left;">&nbsp; I read a lot of what people were doing to color match in various ways. &nbsp;The actual code is in java and I can post it if anyone is interested. &nbsp;However, here's what I basically did.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">&nbsp; &nbsp; &nbsp; Step 1, &nbsp;Processes EVERY pixel and find the most common Hue ( <a href="http://en.wikipedia.org/wiki/HSL_and_HSV">HSV</a> )&nbsp;</div><div class="separator" style="clear: both; text-align: left;">&nbsp; &nbsp; &nbsp; Step 2, &nbsp;Rewalk the pixels and find every one of that Hue and get the most common Saturation and Brightness</div><div class="separator" style="clear: both; text-align: left;">&nbsp; &nbsp; &nbsp; Step 3, &nbsp;I found a Java Library named <a href="http://www.thebuzzmedia.com/software/imgscalr-java-image-scaling-library/">Scalr</a> to do the resize</div><div class="separator" style="clear: both; text-align: left;">&nbsp; &nbsp; &nbsp; Step 4, &nbsp;Center the resized image and pad to make it square using the computed HSV as the padding color.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">&nbsp; Sounds simple but too me a while to figure the way to do this. &nbsp;For this test image, it took ~300ms to process and make all the resized versions. &nbsp;There's probably better/faster ways to do this but this seems to be working for me.</div><div class="separator" style="clear: both; text-align: left;">&nbsp;&nbsp;</div><div class="separator" style="clear: both; text-align: left;">&nbsp; &nbsp; For the image of me above the dominate color happened to be black which is why there are black bars. &nbsp;However to prove it works, here's another example. &nbsp;The color match is on the left and right and I put red lines around the seem on the right.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-qgVDHtLSSWo/UfKBT_nnIpI/AAAAAAAAAsA/BUHCHBv4_A4/s1600/Untitled.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-qgVDHtLSSWo/UfKBT_nnIpI/AAAAAAAAAsA/BUHCHBv4_A4/s1600/Untitled.png" /></a></div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;"><br /></div><h2><span style="font-size: x-large;">Putting it back into the Database.</span></h2><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">&nbsp; Now back to using REST. &nbsp;Now there's 3 images that have been processed and need be updated into the database. &nbsp;Most of what I've shown has been GET requests of the Apex Listener. &nbsp;This will require a POST URI handler. &nbsp;The URI template shows I'll post in the person email address and the size of the image. &nbsp;This is so I know which column to place the updated image into.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-VTniaorhfI4/UfKCk5-aCcI/AAAAAAAAAsM/sINMUrinTpQ/s1600/Screen+Shot+2013-07-26+at+10.06.53+AM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-VTniaorhfI4/UfKCk5-aCcI/AAAAAAAAAsM/sINMUrinTpQ/s1600/Screen+Shot+2013-07-26+at+10.06.53+AM.png" /></a></div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;"><br /></div>The part not in the template anywhere is where the image will be. &nbsp;The Apex Listener makes an automatic bind named :body. &nbsp;This is the body of the file upload. &nbsp;The other thing the listener does is print out anything in the htp.p buffer. &nbsp;Which is why calling F on <a href="http://krisrice.blogspot.com/2013/07/nicer-urls-for-apex-yet-another-option_25.html">this post </a>works. &nbsp;I'm using htp.p in this block simply for debugging progress to see what's going where.<br /><br /><br /><pre class="brush:sql;">declare <br />  p_id number;<br />  img BLOB;<br />begin<br />  /* bring the LOB to a local variable */<br />  img := :body;<br /><br />  /* get the id */<br />  select person_id into p_id<br />    from people p<br />    where email = :email;<br /><br />  /* print the size for debugging */<br />  htp.p('\n******************');<br />  htp.p('Lob size:'|| dbms_lob.getlength(img));<br /><br />  /* based on which size stuff the image into different columns */<br />  if ( :size = 80 ) then <br /><br />     htp.p('Updating 80');<br />     update  photos<br />        set scaled_photo = img<br />      where person_id = p_id;<br />  elsif ( :size = 180 ) then <br /><br />    htp.p('Updating 180');<br />     update  photos<br />        set thumb_photo = img<br />      where person_id = p_id;<br />  elsif ( :size = 436 ) then<br /><br />    htp.p('Updating 436'); <br />      update  photos<br />         set large_thumb_photo = img<br />       where person_id = p_id;<br />  end if;<br /><br />  htp.p('******************');<br /><br />exception when others then<br />  htp.prn(SQLERRM);<br />end;<br /></pre><br /><br /><br /><span style="font-size: x-large;">Putting it all together.</span><br />&nbsp; &nbsp;The actual java code that runs it all is not that interesting. &nbsp;I'm using <a href="http://jackson.codehaus.org/">Jackson</a> to process the JSON of the people's images to process. &nbsp;There's a few libraries out there for JSON processing this one just seemed easy for me to pick up.<br />&nbsp; The posting of the images back is using Apache's <a href="http://hc.apache.org/">HttpClient</a>. &nbsp;Here's that code.<br /><br /><br /><pre class="brush:java;"> HttpClient httpclient = new DefaultHttpClient();<br />    try {<br />      // Create the POST client<br />      HttpPost httppost = new HttpPost("https://myhost.mydomain.com/pls/apex/rest/images/testPost?email="+ email+"&amp;size="+size);<br />     <br />      // The image scaling is done locally to a file then posted<br />      InputStreamEntity reqEntity = new InputStreamEntity(new FileInputStream(file), -1);<br />       <br />      // set the POST to be binary content<br />      reqEntity.setContentType("binary/octet-stream");<br />      reqEntity.setChunked(true);<br />      httppost.setEntity(reqEntity);<br /><br />      System.out.println("executing request " + httppost.getRequestLine());<br />      HttpResponse response = httpclient.execute(httppost);<br />      HttpEntity resEntity = response.getEntity();<br /><br /><br />      System.out.println("----------------------------------------");<br />      System.out.println(response.getStatusLine());<br />      String line = null;<br />      // now print the text from the htp.p debug messages.      <br />      <br />      BufferedReader in = new BufferedReader(new InputStreamReader(resEntity.getContent()));<br />      while( ( line = in.readLine() ) != null ){<br />        System.out.println(line);<br />      }<br />    } finally {<br />      // shut it down<br />      httpclient.getConnectionManager().shutdown();<br />    }<br /></pre><br /><br /><br /><br /><br /><br /><br />