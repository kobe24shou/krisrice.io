---
layout: post
title: How to use RESTful to avoid DB Links with ā'pěks
date: '2013-10-01T16:11:00.000-07:00'
author: Kris Rice
tags:
- ords
modified_time: '2015-07-14T08:47:52.488-07:00'
thumbnail: http://4.bp.blogspot.com/-fAtz62-4OEE/UktQXpytReI/AAAAAAAAAy0/EdGgNsPqk70/s72-c/Screen+Shot+2013-10-01+at+6.44.26+PM.png
blogger_id: tag:blogger.com,1999:blog-37621059.post-4265501538710907393
blogger_orig_url: http://krisrice.blogspot.com/2013/10/how-to-use-restful-to-avoid-db-links.html
---

So the question came up of avoiding a db link by using the APEX Listener's RESTful services to get at the same data. &nbsp;This is all in the context of an Apex application so apex_collections is the obvious place to stuff transient data that could be used over a session.<br /><br />Step 1: &nbsp;Make the RESTful Service.<br />The only catch is to turn pagination off ( make it zero ). &nbsp;I didn't need it for now so this code that follows doesn't account for it.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-fAtz62-4OEE/UktQXpytReI/AAAAAAAAAy0/EdGgNsPqk70/s1600/Screen+Shot+2013-10-01+at+6.44.26+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-fAtz62-4OEE/UktQXpytReI/AAAAAAAAAy0/EdGgNsPqk70/s1600/Screen+Shot+2013-10-01+at+6.44.26+PM.png" /></a></div><br /><br /><br />Step 2. Install <a href="http://sourceforge.net/projects/pljson/">PL/JSON&nbsp;</a><br /><br />&nbsp; In the future this can be done with built in support for JSON in the <a href="http://www.liberidu.com/blog/2013/09/26/oracle-openworld-json-support-in-the-oracle-12c-database-upcoming-new-feature/">database</a>.<br /><br /><br />Step 3. &nbsp;Glue code.<br /><br /><br /><pre class="brush:sql;">declare<br />-- APEX<br />  g_collection_name varchar2(32767) := 'json_data';<br />  <br />-- JSON Portion<br />  l_url  varchar2(32767) := 'http://myhost.mydomain.com/apex/dbtools/features/latestRequests';<br />  l_jsonObj json;<br />  l_jsonObj2 json;<br />  l_jsonKeys json_list;<br />  l_key varchar2(32767);<br />  l_value varchar2(32767);<br />  <br />  l_tempdata json_value;<br />  l_temparray json_list;<br />  i number;  <br />  ii number;  <br /> <br /> values_array dbms_sql.varchar2_table;<br /><br />  procedure varray2collection(p_values dbms_sql.varchar2_table) as<br />    l_sql varchar2(32767) := 'begin APEX_COLLECTION.ADD_MEMBER (p_collection_name =&gt;:NAME,';  <br />    i number;<br />    c number;<br />    ret number;<br />  begin<br />  -- build up the begin..end sql block<br />    for i in 1..p_values.count loop<br />      l_sql := l_sql || 'p_c00'|| i ||'=&gt;:c'||i||',';<br />    end loop;<br />    <br />    -- chop off the last comma<br />    l_sql := substr(l_sql,1,length(l_sql)-1);<br />    -- add the end<br />    l_sql := l_sql || '); end;';<br />    dbms_output.put_line('SQL='||l_sql);<br />    <br />    c := DBMS_SQL.OPEN_CURSOR;<br />    dbms_output.put_line('c='||c);<br />    dbms_sql.parse(c,l_sql,dbms_sql.native);<br />    -- bind in the collection name<br />    dbms_sql.bind_variable(c,':NAME'||i,g_collection_name);<br /><br />    -- bind in the values<br />    for i in 1..p_values.count loop<br />        dbms_sql.bind_variable(c,':c'||i,p_values(i));<br />    end loop;<br />    ret := dbms_sql.execute(c);<br />    dbms_sql.close_cursor(c);<br />    exception when others then<br />       dbms_sql.close_cursor(c);<br />  end;<br />  <br />  -- simple function to remove the leading and trailing "<br />  function trimQuotes(s varchar2) return varchar2 is<br />    l_value varchar2(32767);<br />  begin<br />    l_value := substr(s,2);<br />    l_value := substr(l_value,1,length(l_value)-1);<br />    return l_value;<br />  end;<br />  <br />  -- function to grab the URL and return a JSON object<br />  function getURL(p_url varchar2) return JSON is<br />       -- HTTP Portion<br />      l_http_request   UTL_HTTP.req;<br />      l_http_response  UTL_HTTP.resp;<br />      l_clob           CLOB;<br />      l_text           VARCHAR2(32767);<br />  begin<br />      -- Initialize the CLOB.<br />      DBMS_LOB.createtemporary(l_clob, FALSE);<br />      -- Make a HTTP request and get the response.<br />      l_http_request  := UTL_HTTP.begin_request(l_url);<br />      l_http_response := UTL_HTTP.get_response(l_http_request);<br />      -- Copy the response into the CLOB.<br />       BEGIN<br />          LOOP<br />             UTL_HTTP.read_text(l_http_response, l_text, 32766);<br />             DBMS_LOB.writeappend (l_clob, LENGTH(l_text), l_text);<br />      END LOOP;<br />      EXCEPTION  WHEN UTL_HTTP.end_of_body THEN<br />         null;<br />      END;<br />       UTL_HTTP.END_RESPONSE(l_http_response);<br /><br />    -- Relase the resources associated with the temporary LOB.<br />    dbms_output.put_line('Length:'|| DBMS_LOB.getlength(l_clob));<br />  return json(l_clob);<br />  end geturl;<br />  <br />BEGIN<br />-- apex collection<br />  APEX_COLLECTION.CREATE_OR_TRUNCATE_COLLECTION(g_collection_name);<br /><br />-- JSON<br />    l_jsonObj := getURL(l_url);<br />    -- grab the items <br />    l_temparray:= json_list(l_jsonObj.get('items'));<br />--    temparray := json_list(tempdata);<br />    dbms_output.put_line( 'Count:'|| l_temparray.count);<br />    for i in 1..l_temparray.count loop<br />         -- get the Nth item<br />          l_tempdata :=    l_temparray.get(i);<br />          dbms_output.put_line( 'Record['|| i||']:'|| l_tempdata.to_char);<br />          -- bring the Nth item into it's own json object<br />         l_jsonObj2 := json(l_tempdata);<br />         -- get all the keys to walk<br />         l_jsonKeys := l_jsonobj2.get_keys();<br />                   for ii  in 1..l_jsonKeys.count  loop<br />                      l_key := trimQuotes(l_jsonKeys.get(ii).to_char);<br />                      l_value :=  trimQuotes(l_jsonObj2.get(l_key).to_char);<br />                      dbms_output.put_line(l_key || '=' ||l_value);<br />                      -- build up the array to pass to the apex collection<br />                      values_array(ii) := l_value;<br />                   end loop;<br />                   dbms_output.put_line('LENGTH:'||values_array.count);<br />                   -- send it to the collection<br />                   varray2collection(values_array);<br />        end loop;<br />end;<br />/<br /></pre><br />Step 4. Make a page in Application Express<br /><br />&nbsp; The glue code is in the process named Get JSON. <br />&nbsp; The interactive report is simply: select * from apex_collections.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-_Xf_1EW9Htc/UktLs-oJPUI/AAAAAAAAAyo/JPRfdn3ScIc/s1600/Screen+Shot+2013-10-01+at+6.22.12+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-_Xf_1EW9Htc/UktLs-oJPUI/AAAAAAAAAyo/JPRfdn3ScIc/s1600/Screen+Shot+2013-10-01+at+6.22.12+PM.png" /></a></div><br /><br /><br />Step 5. It's alive<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-9WlUMQhEHYU/UktLs7MlqyI/AAAAAAAAAys/_Fm6toDAqrw/s1600/Screen+Shot+2013-10-01+at+6.21.03+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-9WlUMQhEHYU/UktLs7MlqyI/AAAAAAAAAys/_Fm6toDAqrw/s1600/Screen+Shot+2013-10-01+at+6.21.03+PM.png" /></a></div><br /><br /><br /><br /><br /><div style="-webkit-text-stroke-width: 0px; color: black; font-family: Times; font-size: medium; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; margin: 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;"></div><div class="separator" style="-webkit-text-stroke-width: 0px; clear: both; color: black; font-family: Times; font-size: medium; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; margin: 0px; orphans: auto; text-align: center; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;"></div><div style="-webkit-text-stroke-width: 0px; color: black; font-family: Times; font-size: medium; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; margin: 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;"></div><br /><div style="-webkit-text-stroke-width: 0px; color: black; font-family: Times; font-size: medium; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; margin: 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;"><br /></div><div style="-webkit-text-stroke-width: 0px; color: black; font-family: Times; font-size: medium; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; margin: 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;"><br /></div><div style="-webkit-text-stroke-width: 0px; color: black; font-family: Times; font-size: medium; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; margin: 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;">Oh the ā'pěks is from the oraclenerd&nbsp;<a href="http://oraclenerd.spreadshirt.com/the-joel-A12556589/customize/color/320">store</a>. &nbsp;If you don't have a shirt already, you should.</div><div class="separator" style="clear: both; text-align: center;"><a href="http://image.spreadshirt.com/image-server/v1/compositions/105954408/views/1,width=190,height=190,appearanceId=320.png/the-joel_design.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://image.spreadshirt.com/image-server/v1/compositions/105954408/views/1,width=190,height=190,appearanceId=320.png/the-joel_design.png" /></a></div><br /><br /><br />