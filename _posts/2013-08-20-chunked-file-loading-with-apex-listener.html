---
layout: post
title: 'Chunked File loading with APEX Listener + HTML5 '
date: '2013-08-20T13:25:00.001-07:00'
author: Kris Rice
tags:
- ords
modified_time: '2015-07-14T08:47:52.510-07:00'
thumbnail: http://1.bp.blogspot.com/-1WW4uQ9UzZs/UhO9e-nVBjI/AAAAAAAAAx4/xuuRuZMGq-E/s72-c/Screen+Shot+2013-08-20+at+3.00.51+PM.png
blogger_id: tag:blogger.com,1999:blog-37621059.post-6270148227987006159
blogger_orig_url: http://krisrice.blogspot.com/2013/08/chunked-file-loading-with-apex-listener.html
---

<div class="separator" style="clear: both; text-align: left;">&nbsp; I just found the HTML5 File <a href="http://dev.w3.org/2006/webapi/FileAPI/">API</a>&nbsp;the other day so I had to see what I could do with the APEX Listener's RESTful services. There's a bunch of blogs on what can be done such as on <a href="http://www.html5rocks.com/en/tutorials/file/dndfiles/">HTML5rocks</a>&nbsp; .</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">&nbsp; The end result is that the new File api let's javascript get details of the file and <a href="http://dev.w3.org/2006/webapi/FileAPI/#slice-method-algo">slice</a> it up into parts. Then I made a pretty simple REST end point to receive the chunks and put them back together again.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">The actual sending part of the javascript is here</div><pre class="brush:javascript;">function sendChunk(chunkNumber){<br />        var reader = new FileReader();<br />        var start = chunkSize * (chunkNumber-1);<br />        var end = start + chunkSize -1;<br />      // create the slice of the file<br />        var fileContent = selectedFile.slice(start, end);   <br />      // grab the length<br />        var length = fileContent.size;<br />      <br />      // read the slice of the file<br />        reader.readAsArrayBuffer(fileContent);      <br />      <br />      $.ajax({<br />        url: uri,<br />        type: "POST",<br />        data: fileContent,<br />        processData: false,<br />        beforeSend: function(xhr) {<br />          // pass in the chunk size,offset,name <br />          // as headers<br />                        xhr.setRequestHeader('x-chunknumber', chunkNumber);<br />                        xhr.setRequestHeader('x-filename', selectedFile.name);<br />                        xhr.setRequestHeader('x-offset', start );<br />                        xhr.setRequestHeader('x-chunksize', length );<br />                        xhr.setRequestHeader('x-content-type', selectedFile.type );<br /><br />                    },<br />        success: function (data, status) {<br />          console.log(data);<br />          console.log(status);<br />          bytesUploaded += length;<br />          // set the percent complete <br />          var percentComplete = ((bytesUploaded / selectedFile.size) * 100).toFixed(2);          <br />          $("#fileUploadProgress").text(percentComplete + " %");<br />          <br />          // make a link to the REST that can deliver the file<br />          $("#downloadLink").html("<a href="https://apex.oracle.com/pls/apex/dbtools/example/displayChunkedUpload?f=%22%20+%20selectedFile.name%20+%20%22" target="_new">New File</a>");<br />          <br />          // if there's more chunks send them over<br />          if ( chunkNumber &lt; chunks ) {<br />             sendChunk(chunkNumber+1);<br />          }<br />        },<br />        error: function(xhr, desc, err) {<br />          console.log(desc);<br />          console.log(err);<br />        }<br />      });<br />      <br />    }    <br /> <br /></pre><br />The next step is to make the HTTP Headers into bind variable so the plsql block will be able to use them.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-1WW4uQ9UzZs/UhO9e-nVBjI/AAAAAAAAAx4/xuuRuZMGq-E/s1600/Screen+Shot+2013-08-20+at+3.00.51+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-1WW4uQ9UzZs/UhO9e-nVBjI/AAAAAAAAAx4/xuuRuZMGq-E/s1600/Screen+Shot+2013-08-20+at+3.00.51+PM.png" /></a></div><br /><pre class="brush:sql;">declare<br />  p_b         blob;<br />  p_body      blob;<br />  p_offset    number;<br />  p_filename  varchar2(4000);<br />  p_raw       long raw;<br />  p_chunksize varchar2(200);<br />  p_status    varchar2(200);<br />begin<br />  -- pull the binds into locals<br />  p_offset    := :OFFSET + 1;<br />  p_body      := :body;<br />  p_filename  := :filename;<br />  p_chunksize := :chunksize;<br /><br />  -- NOT FOR PRODUCTION OR REAL APPS<br />  -- If there is a file already with this name nuke it since this is chunk number one.<br />  if ( :chunkNumber = 1 ) then<br />    p_status := 'DELETING';<br />     delete from chunked_upload<br />      where filename = p_filename;<br />  end if;<br /><br />  -- grab the blob storing the first chunks<br />  select blob_data<br />         into p_b<br />    from chunked_upload<br />   where filename = p_filename<br />    for update of blob_data;<br /><br />  p_status :=' WRITING';<br /><br />  -- append it<br />  dbms_lob.append(p_b, p_body);<br /><br />commit;<br />exception <br />  -- if no blob found above do the first insert<br />  when no_data_found then<br />     p_status :=' INSERTING'; <br />     insert into CHUNKED_UPLOAD(filename,blob_data,offset,content_type)<br />      values ( p_filename,p_body,p_offset,:contenttype);  <br />commit;<br />  when others then<br />      -- when something blows out print the error message to the client<br />      htp.p(p_status);<br />      htp.p(SQLERRM);<br />end;<br /></pre><br /><br /><br />A very simple html page for testing it all out.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-Urt-ss1Ohhc/UhO5S8QdUKI/AAAAAAAAAxs/n8F_WzoAsqo/s1600/Screen+Shot+2013-08-20+at+2.45.04+PM.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><br /></a><a href="http://2.bp.blogspot.com/-Urt-ss1Ohhc/UhO5S8QdUKI/AAAAAAAAAxs/n8F_WzoAsqo/s1600/Screen+Shot+2013-08-20+at+2.45.04+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-Urt-ss1Ohhc/UhO5S8QdUKI/AAAAAAAAAxs/n8F_WzoAsqo/s1600/Screen+Shot+2013-08-20+at+2.45.04+PM.png" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: left;">Here's a quick video of how it all works.</div><br /><br /><iframe width="640" height="390" src="http://www.youtube.com/embed/Pxw0nybuMDc" frameborder="0" allowfullscreen></iframe><br /><br />Here's the complete Javascript/html for this sample.<br /><br /><br /><a class="jsbin-embed" href="http://jsbin.com/ObuM/1/embed?html">JS Bin</a><script src="http://static.jsbin.com/js/embed.js"></script>